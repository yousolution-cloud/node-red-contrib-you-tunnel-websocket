<!--
 Copyright 2023 Andrea Trentin.
 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at
		 http://www.apache.org/licenses/LICENSE-2.0
 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
-->

<script type="text/x-red" data-template-name="wstunnel">
  <div class="form-row">
    <label for="node-config-input-name"><i class="fa fa-bookmark"></i> Name</label>
    <input type="text" id="node-config-input-name" placeholder="tunnel name" />
  </div>
  <div class="form-row">
    <label for="node-config-input-host"><i class="fa fa-bookmark"></i> Host</label>
    <input type="text" id="node-config-input-host" placeholder="localhost" style="width: 40%;" />
    <label for="node-config-input-port" style="margin-left: 10px; width: 35px; "> Port</label>
    <input type="text" id="node-config-input-port" placeholder="443" style="width:45px">
  </div>
  <div class="form-row">
    <label for="node-config-input-path"><i class="fa fa-gear"></i> Path </label>
    <input type="text" id="node-config-input-path" placeholder="">
  </div>
  <div class="form-row">
    <span><b>Tunnel Id</b></span>
  </div>
  <div class="form-row" style="padding-left: 10px">
    <span>Name of the http custom header</span>
  </div>
  <div class="form-row">
    <label for="node-config-input-tunnelIdHeaderName"><i class="fa fa-gear"></i> Header </label>
    <input type="text" id="node-config-input-tunnelIdHeaderName" placeholder="x-tunnel-id">
  </div>
  <div class="form-row">
    <label for="node-config-input-logLevel"><i class="fa fa-list"></i> Log Level</label>
    <select id="node-config-input-logLevel" style="width: 150px;">
      <option value="trace">Trace</option>
      <option value="debug">Debug</option>
      <option value="info">Info</option>
      <option value="warning">Warning</option>
      <option value="error">Error</option>
    </select>
  </div>

  <!-- <div class="form-row">
    <label for="node-config-input-srcPort"><i class="fa fa-gear"></i> Source Port</label>
    <input type="text" id="node-config-input-srcPort">
  </div>
  <div class="form-row">
    <label for="node-config-input-dstAddr"><i class="fa fa-gear"></i> Destination Address</label>
    <input type="text" id="node-config-input-dstAddr" placeholder="localhost">
  </div>
  <div class="form-row">
    <label for="node-config-input-dstPort"><i class="fa fa-gear"></i> Destination Port</label>
    <input type="text" id="node-config-input-dstPort">
  </div>
  <div class="form-row">
    <label for="node-config-input-timeout"><i class="fa fa-gear"></i> Timeout</label>
    <input type="text" id="node-config-input-timeout">
  </div> -->
</script>

<script type="text/javascript">
  RED.nodes.registerType('wstunnel', {
    category: 'config',
    color: '#AAAA66',
    defaults: {
      name: { value: '', required: true },
      host: { value: '' },
      port: { value: '' },
      path: { value: '' },
      tunnelIdHeaderName: { value: '' },
      logLevel: { value: 'info' },
    },
    label: function () {
      return this.name;
    },
    oneditprepare: function () {},
  });
</script>

<script type="text/html" data-help-name="wstunnel">
  <p>Configuration node for WebSocket tunnel settings. This node defines the connection parameters and logging configuration for WebSocket tunnel servers.</p>

  <h3>Configuration</h3>
  <dl class="message-properties">
    <dt>Name <span class="property-type">string</span></dt>
    <dd>A descriptive name for this tunnel configuration. This is required and will be displayed in the node list.</dd>

    <dt>Host <span class="property-type">string</span></dt>
    <dd>The hostname or IP address where the WebSocket server will bind. Defaults to <code>localhost</code> if not specified.</dd>

    <dt>Port <span class="property-type">number</span></dt>
    <dd>The port number on which the WebSocket server will listen for connections. Defaults to <code>443</code> if not specified.</dd>

    <dt>Path <span class="property-type">string</span></dt>
    <dd>Optional path component for the WebSocket server URL. Can be left empty for root path connections.</dd>

    <dt>Tunnel ID Header <span class="property-type">string</span></dt>
    <dd>Name of the HTTP custom header used to identify tunnel connections. Defaults to <code>x-tunnel-id</code> if not specified.</dd>

    <dt>Log Level <span class="property-type">string</span></dt>
    <dd>
      Sets the verbosity level for logging output. Available options:
      <ul>
        <li><strong>trace</strong> - Most verbose, includes all debug information</li>
        <li><strong>debug</strong> - Debug information for troubleshooting</li>
        <li><strong>info</strong> - General informational messages (default)</li>
        <li><strong>warning</strong> - Warning messages only</li>
        <li><strong>error</strong> - Error messages only</li>
      </ul>
    </dd>
  </dl>

  <h3>Usage</h3>
  <p>
    This configuration node is used by <code>wstunnel server</code> nodes to define connection parameters. Create one configuration node for each unique set of
    connection settings you need.
  </p>

  <h3>Connection URL</h3>
  <p>The WebSocket server will be accessible at:</p>
  <pre>ws://[host]:[port][/path]</pre>

  <h3>Tunnel ID Header</h3>
  <p>
    The tunnel ID header is used to associate incoming HTTP requests with specific WebSocket connections. Clients should include this header in their requests
    to identify which tunnel to use.
  </p>

  <h3>Log Level Impact</h3>
  <p>The selected log level affects all logging output from the reverse-ws-tunnel library:</p>
  <ul>
    <li><strong>trace/debug</strong> - Useful for development and troubleshooting connection issues</li>
    <li><strong>info</strong> - Recommended for production environments</li>
    <li><strong>warning/error</strong> - Minimal logging for performance-critical environments</li>
  </ul>

  <h3>Example Configuration</h3>
  <ul>
    <li><strong>Name:</strong> "Production Tunnel"</li>
    <li><strong>Host:</strong> "0.0.0.0" (to accept connections from any interface)</li>
    <li><strong>Port:</strong> "8080"</li>
    <li><strong>Path:</strong> "/api/tunnel"</li>
    <li><strong>Header:</strong> "x-tunnel-id"</li>
    <li><strong>Log Level:</strong> "info"</li>
  </ul>

  <h3>Notes</h3>
  <ul>
    <li>Each configuration can be shared by multiple <code>wstunnel server</code> nodes</li>
    <li>Changing the port or host requires redeploying affected server nodes</li>
    <li>Log level changes are applied when server nodes are deployed or restarted</li>
    <li>Ensure the specified port is available and not blocked by firewall rules</li>
  </ul>
</script>

<script type="text/x-red" data-template-name="wstunnel client">
  <div class="form-row">
    <label for="node-input-url"><i class="fa fa-bookmark"></i> Url</label>
    <input type="text" id="node-input-url" placeholder="Url tunnel" />
  </div>
</script>

<script type="text/x-red" data-help-name="wstunnel client">
  <p>
    This node establishes a WebSocket client connection to a remote WebSocket server,
    enabling the creation of an HTTP tunnel over the WebSocket connection. It can be
    used for creating secure connections for web services or routing HTTP traffic through
    a WebSocket channel.
  </p>

  <h3>Parameters</h3>
  <table class="node-help">
    <tr>
      <td><strong>Url</strong></td>
      <td>The URL of the WebSocket server to connect to. This should be in the format `ws://` or `wss://` for secure WebSocket connections. For example: `wss://example.com/socket`.</td>
    </tr>
  </table>

  <h3>Usage</h3>
  <p>
    Once configured, this node will initiate a WebSocket connection to the specified server URL.
    After the connection is established, the node can be used to tunnel HTTP traffic to the remote server.
    This can be useful for scenarios like securely forwarding HTTP requests over a WebSocket connection.
  </p>

  <h3>Example</h3>
  <pre>
    [
      {
        "id": "wstunnel-client-node",
        "type": "wstunnel client",
        "url": "wss://example.com/socket",
        "x": 300,
        "y": 200,
        "wires": []
      }
    ]
  </pre>

  <h3>Notes</h3>
  <ul>
    <li>The node initiates a WebSocket connection when deployed and listens for incoming HTTP requests to tunnel.</li>
    <li>If the connection is closed or fails, the node will attempt to reconnect based on internal reconnection logic.</li>
    <li>Ensure the WebSocket server you're connecting to supports tunneling or is configured to handle this type of traffic.</li>
  </ul>
</script>

<script type="text/javascript">
  RED.nodes.registerType('wstunnel client', {
    category: 'network',
    color: '#a7c957',
    defaults: {
      url: { value: '' },
    },
    inputs: 1,
    outputs: 0,
    icon: 'font-awesome/fa-lock',
    label: function () {
      return this.name || 'tunnel Websocket client';
    },
    labelStyle: function () {
      return this.name ? 'node_label_italic' : '';
    },
  });
</script>

<script type="text/x-red" data-template-name="wstunnel server">
  <div class="form-row">
    <label for="node-input-wstunnel"><i class="fa fa-gears"></i> Cofigure Tunnel Websocket server</label>
    <input type="text" id="node-input-wstunnel">
  </div>
</script>

<script type="text/html" data-help-name="wstunnel server">
  <p>This node starts a WebSocket server for tunneling HTTP traffic over WebSocket connections.</p>

  <h3>Configuration</h3>
  <dl class="message-properties">
    <dt>wstunnel <span class="property-type">config</span></dt>
    <dd>
      Select a <code>wstunnel</code> configuration node that provides server options such as <code>host</code>, <code>port</code>, <code>path</code>,
      <code>tunnel ID header name</code>, and <code>log level</code>.
    </dd>
  </dl>

  <h3>Details</h3>
  <p>When deployed, the node starts a WebSocket server using the port and options defined in the selected <code>wstunnel</code> config node.</p>
  <p>
    The node updates its status to indicate when it is listening and displays the number of connected clients. Connections are automatically closed if the node
    is redeployed or the port is changed.
  </p>
  <p>The server listens for WebSocket connections and uses the configured tunnel ID header to associate incoming connections.</p>
  <p>
    The log level configured in the <code>wstunnel</code> config node is applied when the server starts, controlling the verbosity of logging output from the
    tunnel library.
  </p>

  <h3>Runtime Behavior</h3>
  <ul>
    <li>Status will show <code>listening on port [port]</code> when active.</li>
    <li>Each client connection updates the status with the current number of connected clients.</li>
    <li>All client connections are properly closed when the node is stopped or removed.</li>
  </ul>

  <h3>Logging</h3>
  <dl class="message-properties">
    <dt>Listening</dt>
    <dd>Logs when the WebSocket server is up and listening on the configured port.</dd>
    <dt>Connection</dt>
    <dd>Logs the client IP and port when a new WebSocket client connects.</dd>
    <dt>Disconnection</dt>
    <dd>Logs when a client disconnects and shows remaining connected clients.</dd>
  </dl>

  <h3>Notes</h3>
  <ul>
    <li>
      Ensure the <code>wstunnel</code> config node is correctly configured with a valid <strong>port</strong>, <strong>tunnel ID header</strong>, and
      appropriate <strong>log level</strong>.
    </li>
    <li>Redeploying the flow will gracefully shut down existing WebSocket servers and restart them with updated configuration.</li>
    <li>Log level changes require redeployment to take effect.</li>
    <li>This node does not have input or output wires â€“ it works autonomously based on its configuration.</li>
  </ul>
</script>

<script type="text/javascript">
  RED.nodes.registerType('wstunnel server', {
    category: 'network',
    color: '#a7c957',
    defaults: {
      wstunnel: { type: 'wstunnel', required: true },
      name: { value: '' },
    },
    inputs: 0,
    outputs: 0,
    icon: 'font-awesome/fa-lock',
    label: function () {
      return this.name || 'tunnel Websocket server';
    },
    labelStyle: function () {
      return this.name ? 'node_label_italic' : '';
    },
  });
</script>
